<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20-20 Tradevesting Strategy Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #e53e3e;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1rem;
        }

        .fixed-params {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .param-badge {
            background: #edf2f7;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #2d3748;
        }

        .tsl-note {
            color: #4a5568;
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calculated-value {
            margin-top: 8px;
            padding: 10px;
            background: #edf2f7;
            border-radius: 6px;
            color: #667eea;
            font-weight: 500;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            margin-right: 10px;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .progress-bar.hsl-hit {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .progress-bar.profit {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
        }

        .profit-positive {
            color: #10b981;
            font-weight: 600;
        }

        .profit-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .profit-potential {
            color: #3b82f6;
            font-weight: 600;
        }

        .profit-total {
            background: #f7fafc;
            font-weight: 700;
        }

        .current-level {
            background-color: #fef3c7;
        }

        .timeline {
            margin: 20px 0;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
        }

        .timeline-item.hsl {
            border-left-color: #ef4444;
        }

        .timeline-item.entry {
            border-left-color: #3b82f6;
        }

        .timeline-item.pb {
            border-left-color: #10b981;
        }

        .timeline-item.hsl-hit {
            border-left-color: #dc2626;
            background: #fee2e2;
        }

        .timeline-item.current {
            background: #fef3c7;
        }

        .timeline-item.profit {
            background: #d1fae5;
        }

        .timeline-item.loss {
            background: #fee2e2;
        }

        .timeline-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .timeline-content {
            flex: 1;
        }

        .leg-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
        }

        .leg-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .leg-status.active {
            background: #fef3c7;
            color: #92400e;
        }

        .leg-status.active.profit-bg {
            background: #10b981;
            color: white;
        }

        .leg-status.active.loss-bg {
            background: #ef4444;
            color: white;
        }

        .leg-status.inactive {
            background: #e5e7eb;
            color: #6b7280;
        }

        .order-section {
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }

        .order-section.active {
            border-color: #f59e0b;
        }

        .order-section.completed {
            border-color: #10b981;
        }

        .order-header {
            padding: 20px;
            background: #f7fafc;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .order-section.active .order-header {
            background: #fef3c7;
        }

        .order-section.completed .order-header {
            background: #d1fae5;
        }

        .order-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .order-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .order-section.expanded .toggle-icon {
            transform: rotate(90deg);
        }

        .order-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .order-section.expanded .order-content {
            max-height: 1000px;
        }

        .order-body {
            padding: 25px;
        }

        .current-marker {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .order-detail {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .order-detail-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .execution-note {
            background: #e0f2fe;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #0ea5e9;
        }

        .change-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .arrow {
            color: #667eea;
            font-weight: bold;
        }

        .error {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± 20-20 Tradevesting Strategy Calculator</h1>
            <p class="subtitle">For Educational and Demonstration Purpose Only</p>
            <p>Systematic Profit-Booking Strategy</p>
            <div class="fixed-params">
                <div class="param-badge">Hard Stop Loss (HSL): 20%</div>
                <div class="param-badge">Profit Booking (PB): 20% @ 20% Gain</div>
            </div>
            <div class="tsl-note">TSL = Trailing Stop Loss | Moves to Entry√ó2 when price reaches Entry√ó2.2</div>
        </div>

        <div class="card">
            <div class="card-title">üí∞ Trade Details</div>
            
            <div class="input-group">
                <label>Buy Price (‚Çπ)</label>
                <input type="number" id="buyPrice" step="0.01" placeholder="e.g., 100.50">
                <div class="error hidden" id="buyPriceError"></div>
            </div>

            <div class="input-group">
                <label>Current Price (‚Çπ) - Optional</label>
                <input type="number" id="currentPrice" step="0.01" placeholder="Enter to see your position">
                <div class="error hidden" id="currentPriceError"></div>
            </div>

            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="methodQty" name="method" value="quantity" checked>
                    <label for="methodQty">Enter Quantity</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="methodInv" name="method" value="investment">
                    <label for="methodInv">Enter Investment Amount</label>
                </div>
            </div>

            <div class="input-group" id="quantityGroup">
                <label>Quantity (shares)</label>
                <input type="number" id="quantity" placeholder="e.g., 100">
                <div class="error hidden" id="quantityError"></div>
                <div class="calculated-value hidden" id="calcInvestment"></div>
            </div>

            <div class="input-group hidden" id="investmentGroup">
                <label>Investment Amount (‚Çπ)</label>
                <input type="number" id="investment" step="0.01" placeholder="e.g., 10000">
                <div class="error hidden" id="investmentError"></div>
                <div class="calculated-value hidden" id="calcQuantity"></div>
            </div>

            <div>
                <button class="btn btn-primary" onclick="calculate()">Calculate Orders</button>
                <button class="btn btn-secondary" onclick="reset()">Reset</button>
            </div>
        </div>

        <div class="progress-bar hidden" id="progressBar"></div>

        <div id="results" class="hidden">
            <!-- Trade Blueprint Table -->
            <div class="card">
                <div class="card-title">üìã Trade Blueprint</div>
                <table id="blueprintTable">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Price</th>
                            <th>Sell Qty</th>
                            <th>Remaining Qty</th>
                            <th>Stop Loss</th>
                            <th>Possible Profit</th>
                            <th>Realized Profit</th>
                            <th>Unrealized Profit</th>
                        </tr>
                    </thead>
                    <tbody id="blueprintTableBody"></tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title">üó∫Ô∏è Trade Timeline</div>
                <div class="timeline" id="timeline"></div>
            </div>

            <div class="card">
                <div class="card-title">üìã Order Management</div>
                <div id="orderSections"></div>
            </div>
        </div>
    </div>

    <script>
        let data = null;

        // Method toggle
        document.querySelectorAll('input[name="method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'quantity') {
                    document.getElementById('quantityGroup').classList.remove('hidden');
                    document.getElementById('investmentGroup').classList.add('hidden');
                } else {
                    document.getElementById('quantityGroup').classList.add('hidden');
                    document.getElementById('investmentGroup').classList.remove('hidden');
                }
            });
        });

        // Show investment when quantity entered
        document.getElementById('quantity').addEventListener('input', (e) => {
            const bp = parseFloat(document.getElementById('buyPrice').value);
            const qty = parseInt(e.target.value);
            const el = document.getElementById('calcInvestment');
            
            if (bp && qty) {
                el.textContent = `Investment: ‚Çπ${(bp * qty).toFixed(2)}`;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });

        // Show quantity when investment entered
        document.getElementById('investment').addEventListener('input', (e) => {
            const bp = parseFloat(document.getElementById('buyPrice').value);
            const inv = parseFloat(e.target.value);
            const el = document.getElementById('calcQuantity');
            
            if (bp && inv) {
                el.textContent = `Quantity: ${Math.floor(inv / bp)} shares`;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });

        function calculate() {
            // Clear errors
            document.querySelectorAll('.error').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });

            // Get values
            const buyPrice = parseFloat(document.getElementById('buyPrice').value);
            const currentPrice = parseFloat(document.getElementById('currentPrice').value) || null;
            const method = document.querySelector('input[name="method"]:checked').value;
            
            // Validate
            if (!buyPrice || buyPrice <= 0) {
                document.getElementById('buyPriceError').textContent = 'Enter valid buy price';
                document.getElementById('buyPriceError').classList.remove('hidden');
                return;
            }

            let quantity;
            if (method === 'quantity') {
                quantity = parseInt(document.getElementById('quantity').value);
                if (!quantity || quantity <= 0) {
                    document.getElementById('quantityError').textContent = 'Enter valid quantity';
                    document.getElementById('quantityError').classList.remove('hidden');
                    return;
                }
            } else {
                const investment = parseFloat(document.getElementById('investment').value);
                if (!investment || investment <= 0) {
                    document.getElementById('investmentError').textContent = 'Enter valid amount';
                    document.getElementById('investmentError').classList.remove('hidden');
                    return;
                }
                quantity = Math.floor(investment / buyPrice);
            }

            // Calculate levels with new TSL rule
            const hsl = Math.round(buyPrice * 0.80);
            const pb1 = Math.round(buyPrice * 1.20);
            const pb2 = Math.round(buyPrice * 1.40);
            const pb3 = Math.round(buyPrice * 1.60);
            const pb4 = Math.round(buyPrice * 1.80);
            const entry2x = Math.round(buyPrice * 2.00);
            const entry22x = Math.round(buyPrice * 2.20);
            const qtyPB = Math.round(quantity * 0.20);

            data = {
                buyPrice: buyPrice,
                currentPrice: currentPrice,
                quantity: quantity,
                hsl: hsl,
                pb1: pb1,
                pb2: pb2,
                pb3: pb3,
                pb4: pb4,
                entry2x: entry2x,
                entry22x: entry22x,
                qtyPB: qtyPB
            };

            displayResults();
        }

        function displayResults() {
            const { buyPrice, currentPrice, quantity, hsl, pb1, pb2, pb3, pb4, entry2x, entry22x, qtyPB } = data;

            // Determine leg and HSL status
            let leg = 0;
            let completed = 0;
            let hslHit = false;
            let nextStopLoss = hsl;
            
            if (currentPrice) {
                if (currentPrice < hsl) {
                    leg = -1;
                    hslHit = true;
                } else if (currentPrice < buyPrice) {
                    leg = -1;
                } else if (currentPrice < pb1) {
                    leg = 1;
                    nextStopLoss = hsl;
                } else if (currentPrice < pb2) {
                    leg = 2;
                    completed = 1;
                    nextStopLoss = Math.round(buyPrice);
                } else if (currentPrice < pb3) {
                    leg = 3;
                    completed = 2;
                    nextStopLoss = pb1;
                } else if (currentPrice < pb4) {
                    leg = 4;
                    completed = 3;
                    nextStopLoss = pb2;
                } else if (currentPrice < entry2x) {
                    leg = 5;
                    completed = 4;
                    nextStopLoss = pb3;
                } else if (currentPrice < entry22x) {
                    leg = 6;
                    completed = 4;
                    nextStopLoss = pb4;
                } else {
                    leg = 7;
                    completed = 4;
                    nextStopLoss = entry2x; // TSL moves to Entry√ó2 at Entry√ó2.2
                }

                const progressBar = document.getElementById('progressBar');
                if (hslHit) {
                    progressBar.textContent = `üõë Hard Stop Loss Hit | Price: ‚Çπ${currentPrice.toFixed(2)}`;
                    progressBar.classList.add('hsl-hit');
                    progressBar.classList.remove('profit');
                } else if (currentPrice >= buyPrice) {
                    progressBar.textContent = `üìä Progress: ${completed} of 4 PB Levels Completed | Leg ${leg} Active | TSL: ‚Çπ${nextStopLoss}`;
                    progressBar.classList.add('profit');
                    progressBar.classList.remove('hsl-hit');
                } else {
                    progressBar.textContent = `‚ö†Ô∏è  In Loss Zone | Leg ${leg} Active | TSL: ‚Çπ${nextStopLoss}`;
                    progressBar.classList.remove('hsl-hit', 'profit');
                }
                progressBar.classList.remove('hidden');
            }

            // Display Trade Blueprint Table
            displayTradeBlueprintTable(leg, currentPrice);

            // Timeline
            let timelineHTML = '';
            
            // Add HSL Hit line if applicable
            if (hslHit) {
                timelineHTML += `<div class="timeline-item hsl-hit"><div class="timeline-icon">üõë</div><div class="timeline-content"><strong>Hard Stop Loss Hit @ ‚Çπ${currentPrice.toFixed(2)}</strong><br>YOU ARE HERE</div></div>`;
            }
            
            timelineHTML += `<div class="timeline-item hsl"><div class="timeline-icon">üî¥</div><div class="timeline-content"><strong>Hard Stop Loss (HSL) @ ‚Çπ${hsl}</strong><br>-20%</div></div>`;
            if (currentPrice && leg === -1 && !hslHit) timelineHTML += `<div class="timeline-item current loss"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active loss-bg">‚è≥ Leg -1 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
            
            timelineHTML += `<div class="timeline-item entry"><div class="timeline-icon">üìç</div><div class="timeline-content"><strong>ENTRY @ ‚Çπ${buyPrice.toFixed(2)}</strong><br>0%</div></div>`;
            if (currentPrice && leg === 1) {
                if (currentPrice >= buyPrice) {
                    timelineHTML += `<div class="timeline-item current profit"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active profit-bg">‚è≥ Leg 1 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
                } else {
                    timelineHTML += `<div class="timeline-item current loss"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active loss-bg">‚è≥ Leg 1 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
                }
            } else if (currentPrice && leg > 1) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status completed">‚úÖ Leg 1 COMPLETED</span></div></div>`;
            else if (currentPrice && leg < 1 && !hslHit) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status inactive">‚ö™ Leg 1 (Not reached)</span></div></div>`;
            
            timelineHTML += `<div class="timeline-item pb"><div class="timeline-icon">üü¢</div><div class="timeline-content"><strong>Profit Booking 1 @ ‚Çπ${pb1}</strong><br>+20%</div></div>`;
            if (currentPrice && leg === 2) timelineHTML += `<div class="timeline-item current profit"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active profit-bg">‚è≥ Leg 2 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
            else if (currentPrice && leg > 2) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status completed">‚úÖ Leg 2 COMPLETED</span></div></div>`;
            else if (currentPrice && leg < 2) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status inactive">‚ö™ Leg 2 (Not reached)</span></div></div>`;
            
            timelineHTML += `<div class="timeline-item pb"><div class="timeline-icon">üü¢</div><div class="timeline-content"><strong>Profit Booking 2 @ ‚Çπ${pb2}</strong><br>+40%</div></div>`;
            if (currentPrice && leg === 3) timelineHTML += `<div class="timeline-item current profit"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active profit-bg">‚è≥ Leg 3 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
            else if (currentPrice && leg > 3) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status completed">‚úÖ Leg 3 COMPLETED</span></div></div>`;
            else if (currentPrice && leg < 3) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status inactive">‚ö™ Leg 3 (Not reached)</span></div></div>`;
            
            timelineHTML += `<div class="timeline-item pb"><div class="timeline-icon">üü¢</div><div class="timeline-content"><strong>Profit Booking 3 @ ‚Çπ${pb3}</strong><br>+60%</div></div>`;
            if (currentPrice && leg === 4) timelineHTML += `<div class="timeline-item current profit"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active profit-bg">‚è≥ Leg 4 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
            else if (currentPrice && leg > 4) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status completed">‚úÖ Leg 4 COMPLETED</span></div></div>`;
            else if (currentPrice && leg < 4) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status inactive">‚ö™ Leg 4 (Not reached)</span></div></div>`;
            
            timelineHTML += `<div class="timeline-item pb"><div class="timeline-icon">üü¢</div><div class="timeline-content"><strong>Profit Booking 4 @ ‚Çπ${pb4}</strong><br>+80%</div></div>`;
            if (currentPrice && leg === 5) timelineHTML += `<div class="timeline-item current profit"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active profit-bg">‚è≥ Leg 5 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
            else if (currentPrice && leg > 5) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status completed">‚úÖ Leg 5 COMPLETED</span></div></div>`;
            else if (currentPrice && leg < 5) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status inactive">‚ö™ Leg 5 (Not reached)</span></div></div>`;
            
            timelineHTML += `<div class="timeline-item"><div class="timeline-icon">üü£</div><div class="timeline-content"><strong>2√ó @ ‚Çπ${entry2x}</strong><br>+100%</div></div>`;
            if (currentPrice && leg === 6) timelineHTML += `<div class="timeline-item current profit"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active profit-bg">‚è≥ Leg 6 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
            else if (currentPrice && leg > 6) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status completed">‚úÖ Leg 6 COMPLETED</span></div></div>`;
            else if (currentPrice && leg < 6) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status inactive">‚ö™ Leg 6 (Not reached)</span></div></div>`;
            
            timelineHTML += `<div class="timeline-item"><div class="timeline-icon">üü£</div><div class="timeline-content"><strong>2.2√ó @ ‚Çπ${entry22x}</strong><br>+120% (TSL to 2√ó)</div></div>`;
            if (currentPrice && leg === 7) timelineHTML += `<div class="timeline-item current profit"><div class="timeline-content" style="margin-left:55px"><span class="leg-status active profit-bg">‚è≥ Leg 7 ACTIVE - YOU ARE HERE (‚Çπ${currentPrice.toFixed(2)})</span></div></div>`;
            else if (currentPrice && leg === 7) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status completed">‚úÖ Leg 7 COMPLETED</span></div></div>`;
            else if (currentPrice && leg < 7) timelineHTML += `<div class="timeline-item"><div class="timeline-content" style="margin-left:55px"><span class="leg-status inactive">‚ö™ Leg 7 (Not reached)</span></div></div>`;
            
            document.getElementById('timeline').innerHTML = timelineHTML;

            // Orders
            displayOrders(leg, hslHit);

            document.getElementById('results').classList.remove('hidden');
        }

        function calculateBlueprintProfits(currentLeg, currentPrice) {
            const { buyPrice, quantity, qtyPB, hsl, pb1, pb2, pb3, pb4, entry2x, entry22x } = data;
            
            const levels = [
                { level: -1, name: "HSL @ -20%", price: hsl, sellQty: quantity, remaining: 0, stopLoss: "-", profitPct: -0.20 },
                { level: 0, name: "Entry", price: buyPrice, sellQty: 0, remaining: quantity, stopLoss: hsl, profitPct: 0 },
                { level: 1, name: "PB1 @ +20%", price: pb1, sellQty: qtyPB, remaining: quantity - qtyPB, stopLoss: Math.round(buyPrice), profitPct: 0.20 },
                { level: 2, name: "PB2 @ +40%", price: pb2, sellQty: qtyPB, remaining: quantity - 2*qtyPB, stopLoss: pb1, profitPct: 0.40 },
                { level: 3, name: "PB3 @ +60%", price: pb3, sellQty: qtyPB, remaining: quantity - 3*qtyPB, stopLoss: pb2, profitPct: 0.60 },
                { level: 4, name: "PB4 @ +80%", price: pb4, sellQty: qtyPB, remaining: quantity - 4*qtyPB, stopLoss: pb3, profitPct: 0.80 },
                { level: 5, name: "2√ó @ +100%", price: entry2x, sellQty: 0, remaining: quantity - 4*qtyPB, stopLoss: pb4, profitPct: 1.00 },
                { level: 6, name: "2.2√ó @ +120%", price: entry22x, sellQty: 0, remaining: quantity - 4*qtyPB, stopLoss: entry2x, profitPct: 1.20 }
            ];
            
            let totalRealized = 0;
            let totalUnrealized = 0;
            let currentUnrealizedLevel = -1;
            
            // Determine which level should show unrealized profit
            if (currentPrice) {
                if (currentPrice >= entry22x) {
                    currentUnrealizedLevel = 6; // 2.2√ó
                } else if (currentPrice >= entry2x) {
                    currentUnrealizedLevel = 5; // 2√ó
                } else if (currentPrice >= pb4) {
                    currentUnrealizedLevel = 4; // PB4
                } else if (currentPrice >= pb3) {
                    currentUnrealizedLevel = 3; // PB3
                } else if (currentPrice >= pb2) {
                    currentUnrealizedLevel = 2; // PB2
                } else if (currentPrice >= pb1) {
                    currentUnrealizedLevel = 1; // PB1
                } else if (currentPrice >= buyPrice) {
                    currentUnrealizedLevel = 0; // Entry
                } else if (currentPrice >= hsl) {
                    currentUnrealizedLevel = -1; // Between HSL and Entry
                } else {
                    currentUnrealizedLevel = -1; // HSL hit
                }
            }
            
            levels.forEach(level => {
                // Calculate Possible Profit (fixed at each level)
                if (level.level === -1) {
                    // HSL Possible Profit
                    level.possibleProfit = Math.round(quantity * (hsl - buyPrice));
                } else if (level.level >= 1 && level.level <= 4) {
                    // PB1-PB4 Possible Profit (sell qty √ó profit)
                    level.possibleProfit = Math.round(level.sellQty * (level.price - buyPrice));
                } else if (level.level >= 5) {
                    // 2√ó and 2.2√ó Possible Profit (remaining shares √ó profit)
                    level.possibleProfit = Math.round(level.remaining * (level.price - buyPrice));
                } else {
                    level.possibleProfit = 0;
                }
                
                // Calculate Realized Profit (only for completed PB levels)
                if (level.level >= 1 && level.level <= 4) {
                    // Check if this PB level is completed
                    if (currentPrice && currentPrice >= level.price) {
                        // Price has reached or passed this level
                        level.realizedProfit = Math.round(level.sellQty * (level.price - buyPrice));
                        totalRealized += level.realizedProfit;
                    } else {
                        level.realizedProfit = 0;
                    }
                } else {
                    level.realizedProfit = 0;
                }
                
                // Calculate Unrealized Profit (only at current unrealized level)
                if (level.level === currentUnrealizedLevel && currentPrice) {
                    // Calculate based on remaining shares at this level
                    let remainingAtThisLevel;
                    
                    if (level.level === -1) {
                        // HSL or below entry
                        if (currentPrice < hsl) {
                            // HSL hit - all shares would be sold
                            remainingAtThisLevel = 0;
                            level.unrealizedProfit = Math.round(quantity * (currentPrice - buyPrice));
                        } else {
                            // Between HSL and Entry
                            remainingAtThisLevel = quantity;
                            level.unrealizedProfit = Math.round(remainingAtThisLevel * (currentPrice - buyPrice));
                        }
                    } else if (level.level === 0) {
                        // At Entry level
                        remainingAtThisLevel = quantity;
                        level.unrealizedProfit = Math.round(remainingAtThisLevel * (currentPrice - buyPrice));
                    } else if (level.level >= 1 && level.level <= 4) {
                        // PB levels - calculate remaining shares at this point
                        remainingAtThisLevel = quantity - ((level.level - 1) * qtyPB);
                        level.unrealizedProfit = Math.round(remainingAtThisLevel * (currentPrice - buyPrice));
                    } else {
                        // 2√ó and 2.2√ó levels
                        remainingAtThisLevel = quantity - (4 * qtyPB);
                        level.unrealizedProfit = Math.round(remainingAtThisLevel * (currentPrice - buyPrice));
                    }
                    totalUnrealized = level.unrealizedProfit; // Only one level has unrealized profit
                } else {
                    level.unrealizedProfit = 0;
                }
            });
            
            return { levels, totalRealized, totalUnrealized, currentUnrealizedLevel };
        }

        function displayTradeBlueprintTable(currentLeg, currentPrice) {
            const { levels, totalRealized, totalUnrealized, currentUnrealizedLevel } = calculateBlueprintProfits(currentLeg, currentPrice);
            
            let tableHTML = '';
            
            levels.forEach(level => {
                const isCurrentLevelForUnrealized = level.level === currentUnrealizedLevel;
                const rowClass = isCurrentLevelForUnrealized ? 'current-level' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${level.name}</td>
                        <td>‚Çπ${level.price.toLocaleString()}</td>
                        <td>${level.sellQty > 0 ? level.sellQty : '-'}</td>
                        <td>${level.remaining}</td>
                        <td>${typeof level.stopLoss === 'number' ? '‚Çπ' + level.stopLoss : level.stopLoss}</td>
                        <td class="${level.possibleProfit > 0 ? 'profit-positive' : level.possibleProfit < 0 ? 'profit-negative' : ''}">
                            ${level.possibleProfit !== 0 ? '‚Çπ' + level.possibleProfit.toLocaleString() : '-'}
                        </td>
                        <td class="${level.realizedProfit > 0 ? 'profit-positive' : ''}">
                            ${level.realizedProfit > 0 ? '‚Çπ' + level.realizedProfit.toLocaleString() : '-'}
                        </td>
                        <td class="${level.unrealizedProfit > 0 ? 'profit-positive' : level.unrealizedProfit < 0 ? 'profit-negative' : ''}">
                            ${level.unrealizedProfit !== 0 ? '‚Çπ' + level.unrealizedProfit.toLocaleString() : '-'}
                        </td>
                    </tr>
                `;
            });
            
            // Add totals row
            tableHTML += `
                <tr class="profit-total">
                    <td colspan="5"><strong>TOTALS</strong></td>
                    <td>-</td>
                    <td class="profit-positive"><strong>‚Çπ${totalRealized.toLocaleString()}</strong></td>
                    <td class="${totalUnrealized > 0 ? 'profit-positive' : totalUnrealized < 0 ? 'profit-negative' : ''}">
                        <strong>‚Çπ${totalUnrealized.toLocaleString()}</strong>
                    </td>
                </tr>
            `;
            
            document.getElementById('blueprintTableBody').innerHTML = tableHTML;
        }

        function displayOrders(activeLeg, hslHit) {
            const sections = [
                {leg: 0, title: 'Initial (Leg 1) Orders', range: 'At Entry', fn: getOrderContent},
                {leg: 2, title: 'Leg 2 Orders', range: 'After PB1', fn: getOrderContent},
                {leg: 3, title: 'Leg 3 Orders', range: 'After PB2', fn: getOrderContent},
                {leg: 4, title: 'Leg 4 Orders', range: 'After PB3', fn: getOrderContent},
                {leg: 5, title: 'Leg 5 Orders', range: 'After PB4', fn: getOrderContent},
                {leg: 6, title: 'Leg 6 Orders', range: 'At 2√ó', fn: getOrderContent},
                {leg: 7, title: 'Leg 7 Orders', range: 'At 2.2√ó (TSL to 2√ó)', fn: getOrderContent}
            ];

            let html = '';
            sections.forEach(s => {
                const isActive = s.leg === activeLeg;
                const isCompleted = activeLeg !== null && activeLeg > s.leg;
                const isExpanded = (activeLeg === null && s.leg === 0) || isActive;

                html += `
                    <div class="order-section ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''} ${isExpanded ? 'expanded' : ''}" onclick="this.classList.toggle('expanded')">
                        <div class="order-header">
                            <div class="order-header-left">
                                <span style="font-size:1.5rem">${isCompleted ? '‚úÖ' : (isActive ? '‚è≥' : 'üìã')}</span>
                                <div>
                                    <div class="order-title">${s.title}</div>
                                    <div style="color:#718096;font-size:0.9rem">${s.range}</div>
                                </div>
                            </div>
                            <span class="toggle-icon">‚ñ∂</span>
                        </div>
                        <div class="order-content">
                            <div class="order-body">
                                ${isActive && data.currentPrice ? `<div class="current-marker">üëâ YOU ARE HERE (‚Çπ${data.currentPrice.toFixed(2)})</div>` : ''}
                                ${s.fn(s.leg, activeLeg)}
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('orderSections').innerHTML = html;
        }

        function getOrderContent(sectionLeg, currentLeg) {
            const {buyPrice, hsl, pb1, pb2, pb3, pb4, entry2x, entry22x, quantity, qtyPB} = data;
            
            if (sectionLeg === 0) {
                // Initial orders - dynamic based on current leg
                if (currentLeg === 0 || currentLeg === 1) {
                    // No current price entered or in Leg 1
                    return `
                        <div class="execution-note">
                            üìå No orders executed yet. All orders are pending.
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üõë Order #1 (Stop Loss)</div>
                            <div>Sell ${quantity - qtyPB} shares @ ‚Çπ${hsl} (HSL -20%)</div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üéØ Order #2 (One-Cancels-Other)</div>
                            <div>Sell ${qtyPB} shares @ ‚Çπ${pb1} (PB1 +20% profit)<br>OR @ ‚Çπ${hsl} (HSL)</div>
                        </div>
                    `;
                } else if (currentLeg > 1) {
                    // Leg 1 orders are completed
                    return `
                        <div class="execution-note">
                            üìå Order #2 Executed: ${qtyPB} shares sold @ ‚Çπ${pb1} (+20% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #1 (Modified)</div>
                            <div>Sell ${quantity - qtyPB} shares @ ‚Çπ${hsl} ‚Üí Sell ${quantity - 2*qtyPB} shares @ ‚Çπ${Math.round(buyPrice)} (TSL = Entry)</div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #2 (Executed)</div>
                            <div>${qtyPB} shares sold @ ‚Çπ${pb1} (+20% profit)</div>
                        </div>
                    `;
                }
            } else if (sectionLeg === 2) {
                // Leg 2 orders
                if (currentLeg < 2) {
                    return `<div class="execution-note">‚è≥ Not reached yet. Complete Leg 1 first.</div>`;
                } else if (currentLeg === 2) {
                    return `
                        <div class="execution-note">
                            üìå Order #2 Executed: ${qtyPB} shares sold @ ‚Çπ${pb1} (+20% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üîß Modify Order #1</div>
                            <div>Change:</div>
                            <div class="change-detail">
                                <span>Sell ${quantity - qtyPB} shares @ ‚Çπ${hsl}</span>
                                <span class="arrow">‚Üí</span>
                                <span>Sell ${quantity - 2*qtyPB} shares @ ‚Çπ${Math.round(buyPrice)} (TSL = Entry)</span>
                            </div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚ûï Create Order #3 (OCO)</div>
                            <div>Sell ${qtyPB} shares @ ‚Çπ${pb2} (PB2 +40% profit)<br>OR @ ‚Çπ${Math.round(buyPrice)} (TSL)</div>
                        </div>
                    `;
                } else if (currentLeg > 2) {
                    return `
                        <div class="execution-note">
                            üìå Order #3 Executed: ${qtyPB} shares sold @ ‚Çπ${pb2} (+40% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #1 (Modified)</div>
                            <div>Sell ${quantity - 2*qtyPB} shares @ ‚Çπ${Math.round(buyPrice)} ‚Üí Sell ${quantity - 3*qtyPB} shares @ ‚Çπ${pb1} (TSL = PB1)</div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #3 (Executed)</div>
                            <div>${qtyPB} shares sold @ ‚Çπ${pb2} (+40% profit)</div>
                        </div>
                    `;
                }
            } else if (sectionLeg === 3) {
                // Leg 3 orders
                if (currentLeg < 3) {
                    return `<div class="execution-note">‚è≥ Not reached yet. Complete Leg 2 first.</div>`;
                } else if (currentLeg === 3) {
                    return `
                        <div class="execution-note">
                            üìå Order #3 Executed: ${qtyPB} shares sold @ ‚Çπ${pb2} (+40% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üîß Modify Order #1</div>
                            <div>Change:</div>
                            <div class="change-detail">
                                <span>Sell ${quantity - 2*qtyPB} shares @ ‚Çπ${Math.round(buyPrice)}</span>
                                <span class="arrow">‚Üí</span>
                                <span>Sell ${quantity - 3*qtyPB} shares @ ‚Çπ${pb1} (TSL = PB1)</span>
                            </div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚ûï Create Order #4 (OCO)</div>
                            <div>Sell ${qtyPB} shares @ ‚Çπ${pb3} (PB3 +60% profit)<br>OR @ ‚Çπ${pb1} (TSL)</div>
                        </div>
                    `;
                } else if (currentLeg > 3) {
                    return `
                        <div class="execution-note">
                            üìå Order #4 Executed: ${qtyPB} shares sold @ ‚Çπ${pb3} (+60% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #1 (Modified)</div>
                            <div>Sell ${quantity - 3*qtyPB} shares @ ‚Çπ${pb1} ‚Üí Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb2} (TSL = PB2)</div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #4 (Executed)</div>
                            <div>${qtyPB} shares sold @ ‚Çπ${pb3} (+60% profit)</div>
                        </div>
                    `;
                }
            } else if (sectionLeg === 4) {
                // Leg 4 orders
                if (currentLeg < 4) {
                    return `<div class="execution-note">‚è≥ Not reached yet. Complete Leg 3 first.</div>`;
                } else if (currentLeg === 4) {
                    return `
                        <div class="execution-note">
                            üìå Order #4 Executed: ${qtyPB} shares sold @ ‚Çπ${pb3} (+60% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üîß Modify Order #1</div>
                            <div>Change:</div>
                            <div class="change-detail">
                                <span>Sell ${quantity - 3*qtyPB} shares @ ‚Çπ${pb1}</span>
                                <span class="arrow">‚Üí</span>
                                <span>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb2} (TSL = PB2)</span>
                            </div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚ûï Create Order #5 (OCO)</div>
                            <div>Sell ${qtyPB} shares @ ‚Çπ${pb4} (PB4 +80% profit)<br>OR @ ‚Çπ${pb2} (TSL)</div>
                        </div>
                    `;
                } else if (currentLeg > 4) {
                    return `
                        <div class="execution-note">
                            üìå Order #5 Executed: ${qtyPB} shares sold @ ‚Çπ${pb4} (+80% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #1 (Modified)</div>
                            <div>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb2} ‚Üí Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb3} (TSL = PB3)</div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #5 (Executed)</div>
                            <div>${qtyPB} shares sold @ ‚Çπ${pb4} (+80% profit)</div>
                        </div>
                    `;
                }
            } else if (sectionLeg === 5) {
                // Leg 5 orders (after PB4)
                if (currentLeg < 5) {
                    return `<div class="execution-note">‚è≥ Not reached yet. Complete Leg 4 first.</div>`;
                } else if (currentLeg === 5) {
                    return `
                        <div class="execution-note">
                            üìå Order #5 Executed: ${qtyPB} shares sold @ ‚Çπ${pb4} (+80% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üîß Modify Order #1</div>
                            <div>Change:</div>
                            <div class="change-detail">
                                <span>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb2}</span>
                                <span class="arrow">‚Üí</span>
                                <span>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb3} (TSL = PB3)</span>
                            </div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üéâ All PB Levels Completed!</div>
                            <div>Final ${quantity - 4*qtyPB} shares protected by TSL at ‚Çπ${pb3}</div>
                        </div>
                    `;
                } else if (currentLeg > 5) {
                    return `
                        <div class="execution-note">
                            üìå All 4 PB levels executed. Holding final shares.
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #1 (Modified)</div>
                            <div>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb3} ‚Üí Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb4} (TSL = PB4)</div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ All PB Levels Executed</div>
                            <div>Total profit booked: ${4*qtyPB} shares sold</div>
                        </div>
                    `;
                }
            } else if (sectionLeg === 6) {
                // Leg 6 orders (at 2√ó)
                if (currentLeg < 6) {
                    return `<div class="execution-note">‚è≥ Not reached yet. Price needs to hit 2√ó (100% profit).</div>`;
                } else if (currentLeg === 6) {
                    return `
                        <div class="execution-note">
                            üìå Price reached 2√ó (100% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üîÑ Order #1 Active</div>
                            <div>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb4} (TSL = PB4)</div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üéØ Next Target</div>
                            <div>Price @ ‚Çπ${entry22x} (2.2√ó) will move TSL to ‚Çπ${entry2x} (2√ó)</div>
                        </div>
                    `;
                } else if (currentLeg > 6) {
                    return `
                        <div class="execution-note">
                            üìå Price exceeded 2√ó, moving toward 2.2√ó
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">‚úÖ Order #1 Status</div>
                            <div>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb4} (TSL = PB4)</div>
                        </div>
                    `;
                }
            } else if (sectionLeg === 7) {
                // Leg 7 orders (at 2.2√ó - TSL moves to 2√ó)
                if (currentLeg < 7) {
                    return `<div class="execution-note">‚è≥ Not reached yet. Price needs to hit 2.2√ó (120% profit).</div>`;
                } else if (currentLeg === 7) {
                    return `
                        <div class="execution-note">
                            üìå Price reached 2.2√ó (120% profit)
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üîß Modify Order #1</div>
                            <div>Change:</div>
                            <div class="change-detail">
                                <span>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${pb4}</span>
                                <span class="arrow">‚Üí</span>
                                <span>Sell ${quantity - 4*qtyPB} shares @ ‚Çπ${entry2x} (TSL = 2√ó)</span>
                            </div>
                        </div>
                        <div class="order-detail">
                            <div class="order-detail-title">üéä TSL Secured at 100% Profit!</div>
                            <div>Your final ${quantity - 4*qtyPB} shares now guaranteed minimum 100% profit</div>
                        </div>
                    `;
                }
            }
            
            return '';
        }

        function reset() {
            document.getElementById('buyPrice').value = '';
            document.getElementById('currentPrice').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('investment').value = '';
            document.getElementById('calcInvestment').classList.add('hidden');
            document.getElementById('calcQuantity').classList.add('hidden');
            document.getElementById('methodQty').checked = true;
            document.getElementById('quantityGroup').classList.remove('hidden');
            document.getElementById('investmentGroup').classList.add('hidden');
            document.querySelectorAll('.error').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });
            document.getElementById('results').classList.add('hidden');
            document.getElementById('progressBar').classList.add('hidden');
            document.getElementById('progressBar').classList.remove('hsl-hit', 'profit');
            data = null;
        }
    </script>
</body>
</html>